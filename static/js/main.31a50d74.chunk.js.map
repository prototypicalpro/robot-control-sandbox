{"version":3,"sources":["components/AutoSizer.tsx","robot-sim-utils/Constants.ts","robot-sim-utils/applyRobotEnvironment.ts","robot-sim-utils/DataWindow.ts","robot-sim-utils/MotorModel.ts","components/ControllerEditor.tsx","robot-sim-utils/Controllers.ts","components/RobotSim.tsx","components/Page.tsx","index.tsx"],"names":["AutoSizer","children","style","className","React","widthHeight","setWidthHeight","elemRef","current","size","getBoundingClientRect","width","height","ref","OBJECT_ID","COLLISION_CATEGORY","makeCarComposite","xx","yy","wheelSize","wheelFriction","color","wheelAOffset","wheelBOffset","wheelYOffset","bodyGroup","Body","nextGroup","car","Composite","create","label","body","Bodies","rectangle","collisionFilter","category","CARS","mask","WALLS","group","density","render","fillStyle","rotate","Math","PI","wheelBack","circle","friction","wheels","wheelFront","axelBack","Constraint","bodyB","pointB","x","y","bodyA","stiffness","length","visible","axelFront","add","Common","nextId","nextCategory","DataWindow","initial","curDenque","this","Denque","data","push","shift","toArray","index","peekAt","MotorModel","maxTorque","stuckPowerThresh","stuckAngularVelocityThresh","frictionCoef","deltaTime","motorAngularVelocity","power","totalXForce","abs","CODE_DEFAULT","trim","ControllerEditor","initialCode","onCodeUpdate","code","setCode","codeRef","error","setError","Controller","controllerInstance","Function","Error","step","e","toString","split","display","flexDirection","value","onValueChange","highlight","Prism","languages","javascript","padding","preClassName","Controllers","NO_CONTROLLER","name","TIME_CONTROLLER","BANG_BANG_CONTROLLER","P_CONTROLLER","PI_CONTROLLER","PID_CONTROLLER","MOTION_PROFILE_CONTROLLER","WINDOW_SIZE","MOTOR_SETTINGS","CAR_CONFIGURATIONS","THREE_ROBOTS","config","powerCoef","SINGLE_ROBOT","CAR_CONFIG_MAP","Map","Object","values","map","CONTROLLER_MAP","driveWheel","wheel","force","applyForce","Vector","position","circleRadius","RobotSim","active","simulationActive","setSimulationActive","simulationNumber","setSimulationNumber","curTick","setCurTick","codeSelection","setCodeSelection","factory","setFactory","carSelection","setCarSelection","proccessedTickRef","canvasRef","engineRef","Engine","rendererRef","runnerRef","wheelsRef","pointBRef","tickWindowRef","canvasHeight","canvasWidth","world","wallOpts","isStatic","walls","World","id","SENSOR_B","SENSOR","strokeStyle","lineWidth","applyRobotEnvironment","flag","flagPole","carParts","positionWindow","velocityWindow","powerWindow","motorBack","motorFront","controller","Render","canvas","engine","options","wireframes","showAngleIndicator","background","Events","on","timestamp","lookAt","min","max","Runner","stop","undefined","start","delta","recent","addData","dist","velocity","sensorDistance","time","sensorVelocity","frontPower","angularVelocity","backPower","res","tickVal","timeDomain","i","axisStyle","text","fontSize","fill","title","gridArea","overflowY","flexGrow","alignContent","Form","Control","as","marginRight","onChange","target","get","Array","from","keys","Button","variant","onClick","xDomain","yDomain","margin","left","dontCheckIfEmpty","tickTotal","Page","ReactDOM","StrictMode","document","getElementById"],"mappings":"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","file":"static/js/main.31a50d74.chunk.js","sourcesContent":["import * as React from 'react';\n\ntype WidthHeight = {\n  width: number;\n  height: number;\n};\n\nexport default function AutoSizer({\n  children,\n  style,\n  className\n}: {\n  children: (size: WidthHeight) => React.ReactNode;\n  style?: React.CSSProperties;\n  className?: string;\n}) {\n  const [widthHeight, setWidthHeight] = React.useState<WidthHeight>();\n  const elemRef = React.useRef<HTMLDivElement>(null);\n\n  React.useEffect(() => {\n    if (elemRef.current) {\n      const size = elemRef.current.getBoundingClientRect();\n      setWidthHeight({width: size.width, height: size.height});\n    }\n  }, [setWidthHeight]);\n\n  return (\n    <div\n      ref={elemRef}\n      style={{width: '100%', height: '100%', ...style}}\n      className={className}\n    >\n      {widthHeight ? children(widthHeight) : null}\n    </div>\n  );\n}\n","import {Common, Body} from 'matter-js';\n\nexport enum OBJECT_ID {\n  SENSOR_B = Common.nextId()\n}\n\nexport enum COLLISION_CATEGORY {\n  WALLS = Body.nextCategory(),\n  CARS = Body.nextCategory(),\n  SENSOR = Body.nextCategory()\n}\n","import {World, Bodies, Body, Composite, Constraint} from 'matter-js';\nimport {OBJECT_ID, COLLISION_CATEGORY} from './Constants';\n\n// const NO_DENSITY = 1e-30;\n\n/**\n * Creates a composite with simple car setup of bodies and constraints.\n *\n * @param {number} xx\n * @param {number} yy\n * @param {number} width\n * @param {number} height\n * @param {number} wheelSize\n * @returns {composite} A new composite car body\n */\nexport function makeCarComposite(\n  xx: number,\n  yy: number,\n  width: number,\n  height: number,\n  wheelSize: number,\n  wheelFriction: number,\n  color?: {\n    flag?: string;\n    body?: string;\n    wheels?: string;\n    flagPole?: string;\n  }\n): [Composite, {body: Body; wheelBack: Body; wheelFront: Body}] {\n  const wheelBase = 20,\n    wheelAOffset = -width * 0.5 + wheelBase,\n    wheelBOffset = width * 0.5 - wheelBase,\n    wheelYOffset = width * 0.5 - wheelBase;\n  // flagXOffset = width * -0.5,\n  // flagYOffset = height * -0.5;\n  const bodyGroup = Body.nextGroup(false);\n\n  const car = Composite.create({label: 'Car'});\n  const body = Bodies.rectangle(xx, yy, width, height, {\n    collisionFilter: {\n      category: COLLISION_CATEGORY.CARS,\n      mask: COLLISION_CATEGORY.WALLS,\n      group: bodyGroup\n    },\n    density: 0.0001,\n    render: {\n      fillStyle: color?.body\n    }\n  });\n\n  Body.rotate(body, Math.PI);\n\n  const wheelBack = Bodies.circle(\n    xx + wheelAOffset,\n    yy + wheelYOffset,\n    wheelSize,\n    {\n      collisionFilter: {\n        category: COLLISION_CATEGORY.CARS,\n        mask: COLLISION_CATEGORY.WALLS\n      },\n      friction: wheelFriction,\n      render: {\n        fillStyle: color?.wheels\n      }\n    }\n  );\n\n  const wheelFront = Bodies.circle(\n    xx + wheelBOffset,\n    yy + wheelYOffset,\n    wheelSize,\n    {\n      collisionFilter: {\n        category: COLLISION_CATEGORY.CARS,\n        mask: COLLISION_CATEGORY.WALLS\n      },\n      friction: wheelFriction,\n      render: {\n        fillStyle: color?.wheels\n      }\n    }\n  );\n\n  const axelBack = Constraint.create({\n    bodyB: body,\n    pointB: {x: wheelAOffset, y: wheelYOffset},\n    bodyA: wheelBack,\n    stiffness: 1,\n    length: 0,\n    render: {\n      visible: false\n    }\n  });\n\n  const axelFront = Constraint.create({\n    bodyB: body,\n    pointB: {x: wheelBOffset, y: wheelYOffset},\n    bodyA: wheelFront,\n    stiffness: 1,\n    length: 0,\n    render: {\n      visible: false\n    }\n  });\n\n  // const particleRadius = 5;\n  // const rowCount = 5;\n  // const flagPole = Composites.softBody(\n  //   xx + flagXOffset - particleRadius,\n  //   yy + flagYOffset - particleRadius * (2 * rowCount - 1),\n  //   2,\n  //   rowCount,\n  //   0,\n  //   0,\n  //   true,\n  //   particleRadius,\n  //   {\n  //     render: {\n  //       visible: true,\n  //       fillStyle: color?.flagPole\n  //     },\n  //     density: 0.001,\n  //     slop: 0.005,\n  //     collisionFilter: {\n  //       category: COLLISION_CATEGORY.CARS,\n  //       mask: COLLISION_CATEGORY.WALLS,\n  //       group: bodyGroup\n  //     }\n  //   },\n  //   {\n  //     stiffness: 0.5\n  //   }\n  // );\n\n  // const leftFlagMountPoint = flagPole.bodies[flagPole.bodies.length - 2];\n  // const rightFlagMountPoint = flagPole.bodies[flagPole.bodies.length - 1];\n\n  // const flagBodyLeft = Constraint.create({\n  //   bodyB: body,\n  //   pointB: {x: flagXOffset, y: flagYOffset},\n  //   bodyA: leftFlagMountPoint,\n  //   stiffness: 1,\n  //   length: 0\n  // });\n\n  // const flagBodyRight = Constraint.create({\n  //   bodyB: body,\n  //   pointB: {x: flagXOffset + 2 * particleRadius, y: flagYOffset},\n  //   bodyA: rightFlagMountPoint,\n  //   stiffness: 1,\n  //   length: 0\n  // });\n\n  // const flagRadius = (4 * particleRadius) / Math.sqrt(3);\n  // const flagTriangle = Bodies.polygon(\n  //   xx + flagXOffset - 2 * particleRadius - 2,\n  //   yy + flagYOffset - particleRadius * (rowCount + 1),\n  //   3,\n  //   flagRadius,\n  //   {\n  //     density: NO_DENSITY,\n  //     collisionFilter: {\n  //       category: COLLISION_CATEGORY.CARS,\n  //       mask: COLLISION_CATEGORY.WALLS,\n  //       group: bodyGroup\n  //     },\n  //     render: {\n  //       fillStyle: color?.flag\n  //     }\n  //   }\n  // );\n\n  // const flagMount = Constraint.create({\n  //   bodyB: flagPole.bodies[2],\n  //   pointB: {x: 0, y: 0},\n  //   bodyA: flagTriangle,\n  //   pointA: {x: flagRadius / 2, y: 0},\n  //   stiffness: 0.9\n  // });\n\n  Composite.add(car, body);\n  Composite.add(car, wheelBack);\n  Composite.add(car, wheelFront);\n  Composite.add(car, axelBack);\n  Composite.add(car, axelFront);\n  // Composite.add(car, flagPole);\n  // Composite.add(car, flagBodyLeft);\n  // Composite.add(car, flagBodyRight);\n  // Composite.add(car, flagTriangle);\n  // Composite.add(car, flagMount);\n\n  return [\n    car,\n    {\n      body,\n      wheelBack,\n      wheelFront\n    }\n  ];\n}\n\nexport function applyRobotEnvironment(\n  world: World,\n  width: number,\n  height: number,\n  color?: {\n    walls?: string;\n  }\n) {\n  // walls\n  const wallOpts = {\n    isStatic: true,\n    render: {fillStyle: color?.walls},\n    collisionFilter: {\n      category: COLLISION_CATEGORY.WALLS,\n      mask: COLLISION_CATEGORY.CARS\n    }\n  };\n  World.add(world, [\n    // walls\n    Bodies.rectangle(width / 2, 0, width, 50, wallOpts),\n    Bodies.rectangle(width / 2, height, width, 50, wallOpts),\n    Bodies.rectangle(width, height / 2, 50, height, wallOpts),\n    Bodies.rectangle(0, height / 2, 50, height, wallOpts)\n  ]);\n  // create the destination point\n  const pointB = Bodies.rectangle(width * 0.8, height / 2, 1, height, {\n    isStatic: true,\n    id: OBJECT_ID.SENSOR_B,\n    collisionFilter: {\n      category: COLLISION_CATEGORY.SENSOR\n    },\n    render: {\n      strokeStyle: 'black',\n      fillStyle: 'transparent',\n      lineWidth: 1\n    }\n  });\n  World.add(world, pointB);\n\n  return {\n    pointB\n  };\n}\n","import Denque from 'denque';\n\nexport default class DataWindow<Data> {\n  private readonly size: number;\n  private readonly initial: Data[];\n  private curDenque: Denque<Data>;\n\n  constructor(size: number, initial: Data[] = []) {\n    this.size = size;\n    this.initial = [...initial];\n    this.curDenque = new Denque(initial);\n  }\n\n  addData(data: Data) {\n    this.curDenque.push(data);\n    if (this.curDenque.length >= this.size) this.curDenque.shift();\n  }\n\n  values(): readonly Data[] {\n    return this.curDenque.toArray();\n  }\n\n  recent(index: number = 0): Data {\n    return this.curDenque.peekAt(this.curDenque.length - index - 1) as Data;\n  }\n\n  get(index: number): Data {\n    return this.curDenque.peekAt(index) as Data;\n  }\n\n  reset() {\n    this.curDenque = new Denque(this.initial);\n  }\n\n  count(): number {\n    return this.curDenque.length;\n  }\n}\n","export default class MotorModel {\n  private readonly maxTorque: number;\n  private readonly stuckPowerThresh: number;\n  private readonly stuckAngularVelocityThresh: number;\n  private readonly frictionCoef: number;\n\n  constructor({\n    maxTorque,\n    stuckPowerThresh,\n    stuckAngularVelocityThresh,\n    frictionCoef\n  }: {\n    maxTorque: number;\n    stuckPowerThresh: number;\n    stuckAngularVelocityThresh: number;\n    frictionCoef: number;\n  }) {\n    this.maxTorque = maxTorque;\n    this.stuckPowerThresh = stuckPowerThresh;\n    this.stuckAngularVelocityThresh = stuckAngularVelocityThresh;\n    this.frictionCoef = frictionCoef;\n  }\n\n  step(deltaTime: number, motorAngularVelocity: number, power: number) {\n    // apply a force opposite to the direction the robot is currently moving\n    // this simulates the \"internal friction\" of the motors\n    let totalXForce = motorAngularVelocity * this.frictionCoef;\n    // if the power is under a certain threshold and the robot is \"stopped\",\n    // the motor stalls and we stop applying any force\n    if (\n      Math.abs(motorAngularVelocity) >= this.stuckAngularVelocityThresh ||\n      Math.abs(power) >= this.stuckPowerThresh\n    ) {\n      totalXForce += power * this.maxTorque;\n    }\n    // return the force * time\n    return totalXForce * deltaTime;\n  }\n}\n","import * as React from 'react';\nimport Editor from 'react-simple-code-editor';\nimport Prism from 'prismjs';\nimport 'prism-themes/themes/prism-vsc-dark-plus.css';\nimport 'prismjs/components/prism-clike';\nimport 'prismjs/components/prism-javascript';\nimport {ControllerFactory} from '../robot-sim-utils/Controller';\nimport './ControllerEditor.css';\n\nconst CODE_DEFAULT = `\nclass Controller {\n  constructor() {\n\n  }\n\n  step(sensorDistance, time, delta) {\n    return 1\n  }\n}`.trim();\n\nexport default function ControllerEditor({\n  initialCode = CODE_DEFAULT,\n  onCodeUpdate,\n  style = {}\n}: {\n  onCodeUpdate: (code: ControllerFactory) => void;\n  initialCode?: string;\n  style?: React.CSSProperties;\n}) {\n  const [code, setCode] = React.useState(initialCode);\n  const codeRef = React.useRef<string>();\n  const [error, setError] = React.useState<string>();\n\n  React.useEffect(() => {\n    setCode(initialCode);\n  }, [initialCode]);\n\n  React.useEffect(() => {\n    if (code !== codeRef.current) {\n      codeRef.current = code;\n      let Controller;\n      try {\n        // I know I know\n        // eslint-disable-next-line no-new-func\n        Controller = Function(`\"use strict\"; ${code}; return Controller;`)();\n        const controllerInstance = new Controller();\n        if (!(controllerInstance instanceof Controller))\n          throw new Error('Not a class');\n        if (!(controllerInstance.step instanceof Function))\n          throw new Error('No step() function on class');\n      } catch (e) {\n        setError(e.toString().split('\\n')[0]);\n        return;\n      }\n      setError('');\n      onCodeUpdate(Controller as ControllerFactory);\n    }\n  }, [code, onCodeUpdate]);\n\n  return (\n    <div\n      style={{\n        display: 'flex',\n        flexDirection: 'column',\n        ...style\n      }}\n    >\n      <Editor\n        value={code}\n        onValueChange={setCode}\n        highlight={code =>\n          Prism.highlight(code, Prism.languages.javascript, 'javascript')\n        }\n        padding={10}\n        className=\"controller-editor-container\"\n        preClassName=\"controller-editor-highlight\"\n      />\n      <p style={{color: '#d4d4d4'}}>{error}</p>\n    </div>\n  );\n}\n","const Controllers = {\n  NO_CONTROLLER: {\n    name: 'No Controller',\n    code: `\n// Click to edit, or use the dropdown below to select a template\n// then press play to simulate your controller.\n\nclass Controller {\n  step() {\n    return 1\n  }\n}`.trim()\n  },\n\n  TIME_CONTROLLER: {\n    name: 'Dead Reckoning',\n    code: `\nconst DRIVE_TIME = 0; // <-- Change me!\n\nclass Controller {\n  constructor() {\n    this.initialTime = null\n  }\n\n  step({time}) {\n    if (this.initialTime === null)\n      this.initialTime = time\n    const timeHasPassed = time - this.initialTime\n    if (timeHasPassed > DRIVE_TIME) return 0\n    else return 1\n  }\n}`.trim()\n  },\n\n  BANG_BANG_CONTROLLER: {\n    name: 'Bang-Bang Controller',\n    code: `\nclass Controller {\n  step({sensorDistance}) {\n    if (sensorDistance > 0) return 1\n    else if (sensorDistance < 0) return -1\n    else return 0\n  }\n}`.trim()\n  },\n\n  P_CONTROLLER: {\n    name: 'P Controller',\n    code: `\nconst P_TERM = 0 // <-- Change me!\n\nclass Controller {\n  step({sensorDistance}) {\n    return sensorDistance*P_TERM\n  }\n}`.trim()\n  },\n\n  PI_CONTROLLER: {\n    name: 'PI Controller',\n    code: `\nconst P_TERM = 0.003\nconst I_TERM = 0 // <-- Change me!\nconst I_CUTOFF = 0 // <-- Change me!\n\nclass Controller {\n  constructor() {\n    this.integral = 0\n  }\n\n  step({sensorDistance, delta}) {\n    if (Math.abs(sensorDistance) > I_CUTOFF) {\n      this.integral = 0\n    }\n    else {\n      this.integral += sensorDistance*delta\n    }\n\n    return sensorDistance*P_TERM + this.integral*I_TERM\n  }\n}`.trim()\n  },\n\n  PID_CONTROLLER: {\n    name: 'PID Controller',\n    code: `\nconst P_TERM = 0.003, I_TERM = 0.001, I_CUTOFF = 20, D_TERM = 0 // <-- Change me!\n\nclass Controller {\n  constructor() { this.integral = 0, this.prevDistance = null }\n\n  step({sensorDistance, delta}) {\n    if (this.prevDistance === null) this.prevDistance = sensorDistance\n\n    if (Math.abs(sensorDistance) > I_CUTOFF) this.integral = 0\n    else this.integral += sensorDistance * delta\n\n    let der = (sensorDistance - this.prevDistance) / delta\n    this.prevDistance = sensorDistance\n\n    return sensorDistance*P_TERM + this.integral*I_TERM + der*D_TERM\n  }\n}`.trim()\n  },\n\n  MOTION_PROFILE_CONTROLLER: {\n    name: 'Motion Profile Controller',\n    code: `\nconst CRUISE_VELOCITY = 200, MAX_ACCEL = 200, CORNER_TIME = CRUISE_VELOCITY / MAX_ACCEL;\nconst V_TERM = 0.0013, P_TERM = -0.004;\n\n// See https://youtu.be/8319J1BEHwM For more information on what this controller does.\n\nclass Controller {\n  constructor() { this.totalDistance = null; this.initialTime = null; }\n\n  getDesiredVelocityAndPosition(time) {\n    const cruiseDistance =\n      this.totalDistance - CRUISE_VELOCITY * CORNER_TIME\n    const cruiseTime = cruiseDistance / CRUISE_VELOCITY\n    const backCornerTime = CORNER_TIME + cruiseTime\n\n    let velocity\n    if (time < CORNER_TIME) {\n      velocity = (CRUISE_VELOCITY / CORNER_TIME) * time\n    } else if (time < backCornerTime) {\n      velocity = CRUISE_VELOCITY\n    } else {\n      velocity = Math.max(\n        (CRUISE_VELOCITY / CORNER_TIME) * (backCornerTime - time) +\n          CRUISE_VELOCITY,\n        0\n      );\n    }\n\n    let position;\n    if (time < CORNER_TIME) position = 0.5 * MAX_ACCEL * Math.pow(time, 2)\n    else if (time < backCornerTime)\n      position = 0.5 * MAX_ACCEL * Math.pow(CORNER_TIME, 2) + CRUISE_VELOCITY * (time - CORNER_TIME)\n    else if (time < backCornerTime + CORNER_TIME)\n      position =\n        0.5 * MAX_ACCEL * Math.pow(CORNER_TIME, 2) +\n        CRUISE_VELOCITY * cruiseTime +\n        CRUISE_VELOCITY * (time - backCornerTime) - 0.5 * MAX_ACCEL * Math.pow(time - backCornerTime, 2)\n    else position = this.totalDistance\n\n    console.log(time, position)\n    return {position, velocity}\n  }\n\n  step({sensorDistance, delta, time}) {\n    if (this.totalDistance === null) {\n      this.totalDistance = sensorDistance\n      this.initialTime = time\n    }\n\n    const {position, velocity} = this.getDesiredVelocityAndPosition((time - this.initialTime))\n    const error = (this.totalDistance - position) - sensorDistance\n    return V_TERM*velocity + P_TERM*error\n  }\n}\n`.trim()\n  }\n};\n\nexport default Controllers;\n","import * as React from 'react';\nimport {Engine, Render, World, Events, Body, Vector, Runner} from 'matter-js';\nimport '../../node_modules/react-vis/dist/style.css';\nimport {\n  XYPlot,\n  XAxis,\n  YAxis,\n  HorizontalGridLines,\n  LineSeriesCanvas\n} from 'react-vis';\nimport Button from 'react-bootstrap/Button';\nimport Form from 'react-bootstrap/Form';\nimport {\n  applyRobotEnvironment,\n  makeCarComposite\n} from '../robot-sim-utils/applyRobotEnvironment';\nimport DataWindow from '../robot-sim-utils/DataWindow';\nimport MotorModel from '../robot-sim-utils/MotorModel';\nimport {Controller, ControllerFactory} from '../robot-sim-utils/Controller';\nimport ControllerEditor from './ControllerEditor';\nimport Controllers from '../robot-sim-utils/Controllers';\nimport './RobotSim.css';\n\nconst CAR_SCALE = 0.8;\nconst WINDOW_SIZE = 300;\nconst MIN_GRAPH_TIME = 500;\nconst GRAPH_TICK_WAIT = 0;\nconst MOTOR_SETTINGS = {\n  frictionCoef: -0.001,\n  maxTorque: 0.0006,\n  stuckPowerThresh: 0.05,\n  stuckAngularVelocityThresh: 0.5\n};\n\nconst CAR_CONFIGURATIONS = {\n  THREE_ROBOTS: {\n    name: 'Three Robots',\n    config: [\n      {powerCoef: 1, color: '#ff0000'},\n      {powerCoef: 0.9, color: '#00ff00'},\n      {powerCoef: 0.8, color: '#0000ff'}\n    ]\n  },\n  SINGLE_ROBOT: {\n    name: 'Single Robot',\n    config: [{powerCoef: 1, color: '#FFA500'}]\n  }\n};\n\nconst CAR_CONFIG_MAP = new Map(\n  Object.values(CAR_CONFIGURATIONS).map(({name, config}) => [name, config])\n);\nconst CONTROLLER_MAP = new Map(\n  Object.values(Controllers).map(({name, code}) => [name, code])\n);\n\nfunction driveWheel(wheel: Body, force: number) {\n  Body.applyForce(\n    wheel,\n    Vector.add(wheel.position, Vector.create(0, wheel.circleRadius)),\n    Vector.create(-force, 0)\n  );\n  Body.applyForce(\n    wheel,\n    Vector.add(\n      wheel.position,\n      Vector.create(0, -(wheel.circleRadius as number))\n    ),\n    Vector.create(force, 0)\n  );\n}\n\nconst RobotSim: React.FunctionComponent<{\n  width: number;\n  height: number;\n  style?: React.CSSProperties;\n  className?: string;\n  active?: boolean;\n}> = ({style, className, width, height, active}) => {\n  const [simulationActive, setSimulationActive] = React.useState(false);\n  const [simulationNumber, setSimulationNumber] = React.useState(1);\n  const [curTick, setCurTick] = React.useState(0);\n  const [codeSelection, setCodeSelection] = React.useState(\n    Controllers.NO_CONTROLLER\n  );\n  const [factory, setFactory] = React.useState<{factory: ControllerFactory}>();\n  const [carSelection, setCarSelection] = React.useState(\n    CAR_CONFIGURATIONS.THREE_ROBOTS\n  );\n  const proccessedTickRef = React.useRef<number>(0);\n  const canvasRef = React.useRef<HTMLCanvasElement>(null);\n  const engineRef = React.useRef(Engine.create());\n  const rendererRef = React.useRef<Render>();\n  const runnerRef = React.useRef<Runner>();\n  const wheelsRef = React.useRef<\n    {\n      wheelFront: Body;\n      wheelBack: Body;\n      body: Body;\n      positionWindow: DataWindow<number>;\n      velocityWindow: DataWindow<number>;\n      powerWindow: DataWindow<number>;\n      motorFront: MotorModel;\n      motorBack: MotorModel;\n      controller: Controller;\n      powerCoef: number;\n      color: string;\n    }[]\n  >();\n  const pointBRef = React.useRef<Body>();\n  const tickWindowRef = React.useRef<DataWindow<DOMHighResTimeStamp>>();\n\n  const canvasHeight = height / 3;\n  const canvasWidth = width;\n\n  // setup engine and world\n  React.useEffect(() => {\n    if (canvasRef.current && factory && simulationNumber && active) {\n      // reset the engine\n      engineRef.current = Engine.create();\n      // reset the processed tick and current tick\n      tickWindowRef.current = new DataWindow(WINDOW_SIZE);\n      setCurTick(0);\n      proccessedTickRef.current = 0;\n      setSimulationActive(false);\n      // generate the environment\n      const {pointB} = applyRobotEnvironment(\n        engineRef.current.world,\n        canvasWidth,\n        canvasHeight\n      );\n      pointBRef.current = pointB;\n      // generate a number of cars\n      wheelsRef.current = [];\n      for (const {powerCoef, color} of carSelection.config) {\n        const [car, carParts] = makeCarComposite(\n          150,\n          canvasHeight - 95,\n          150 * CAR_SCALE,\n          150 * CAR_SCALE,\n          40 * CAR_SCALE,\n          0.2,\n          {\n            body: `${color}a0`,\n            wheels: `${color}a0`,\n            flag: '#ff4500a0',\n            flagPole: `${color}a0`\n          }\n        );\n        World.add(engineRef.current.world, car);\n        wheelsRef.current.push({\n          ...carParts,\n          positionWindow: new DataWindow(WINDOW_SIZE),\n          velocityWindow: new DataWindow(WINDOW_SIZE),\n          powerWindow: new DataWindow(WINDOW_SIZE),\n          motorBack: new MotorModel(MOTOR_SETTINGS),\n          motorFront: new MotorModel(MOTOR_SETTINGS),\n          controller: new factory.factory(),\n          powerCoef,\n          color\n        });\n      }\n      // generate a renderer\n      rendererRef.current = Render.create({\n        canvas: canvasRef.current,\n        engine: engineRef.current,\n        options: {\n          width: canvasWidth,\n          height: canvasHeight,\n          wireframes: false,\n          showAngleIndicator: true,\n          background: '#d4d4d4'\n          // showCollisions: true\n        } as any\n      });\n      // set react to tick with the engine\n      Events.on(engineRef.current, 'afterTick', ({timestamp}) =>\n        setCurTick(timestamp)\n      );\n      // fit the render viewport to the scene\n      Render.lookAt(rendererRef.current, {\n        min: {x: 0, y: 0},\n        max: {x: canvasWidth, y: canvasHeight}\n      });\n      // run the Renderer once for a start freeze frame\n      Render.world(rendererRef.current);\n      // start the physics runner\n      // we let it run independently because react is too slow to keep up\n      runnerRef.current = Runner.create();\n      // cleanup\n      return () => {\n        // stop the runner\n        if (runnerRef.current) {\n          Runner.stop(runnerRef.current);\n          runnerRef.current = undefined;\n        }\n      };\n    }\n  }, [\n    canvasRef,\n    engineRef,\n    rendererRef,\n    canvasWidth,\n    canvasHeight,\n    carSelection,\n    simulationNumber,\n    active,\n    factory\n  ]);\n\n  // handle play/pause changes\n  React.useEffect(() => {\n    if (runnerRef.current && engineRef.current && simulationActive && active) {\n      Runner.start(runnerRef.current, engineRef.current);\n      return () => Runner.stop(runnerRef.current as Runner);\n    }\n  }, [runnerRef, engineRef, simulationActive, active]);\n\n  // handle ticks\n  React.useEffect(() => {\n    if (\n      rendererRef.current &&\n      tickWindowRef.current &&\n      wheelsRef.current &&\n      pointBRef.current &&\n      proccessedTickRef.current < curTick\n    ) {\n      // render the world\n      Render.world(rendererRef.current);\n      // every someodd ticks, update the graph\n      if (proccessedTickRef.current + GRAPH_TICK_WAIT < curTick) {\n        // indicate we have processed the next tick\n        proccessedTickRef.current = curTick;\n        // calculate vectors\n        const delta = curTick - (tickWindowRef.current.recent() || 0);\n        // update tick state\n        tickWindowRef.current.addData(curTick);\n        // update the model cars\n        for (const {\n          wheelBack,\n          wheelFront,\n          motorBack,\n          motorFront,\n          controller,\n          body,\n          positionWindow,\n          velocityWindow,\n          powerWindow,\n          powerCoef\n        } of wheelsRef.current) {\n          // calculate velocities and such\n          const dist = pointBRef.current.position.x - body.position.x;\n          const velocity = positionWindow.recent()\n            ? -(dist - positionWindow.recent()) / (delta / 1e3)\n            : 0;\n          // update other state\n          positionWindow.addData(dist);\n          velocityWindow.addData(velocity);\n          const rawPower = Math.min(\n            1,\n            Math.max(\n              -1,\n              controller.step({\n                sensorDistance: dist,\n                delta: delta / 1e3, // milliseconds to seconds\n                time: curTick / 1e3,\n                sensorVelocity: velocity\n              })\n            )\n          );\n          // run the controller\n          const power = rawPower * powerCoef;\n          powerWindow.addData(power);\n          // step the motors based on the values we just calculated\n          const frontPower = motorFront.step(\n            delta,\n            wheelFront.angularVelocity,\n            power\n          );\n          const backPower = motorBack.step(\n            delta,\n            wheelBack.angularVelocity,\n            power\n          );\n          // apply forces\n          driveWheel(wheelFront, frontPower);\n          driveWheel(wheelBack, backPower);\n        }\n      }\n    }\n  }, [curTick]);\n\n  // generate data by zipping the tickWindow with all the other properties\n  const res = React.useMemo(() => {\n    if (tickWindowRef.current && wheelsRef.current) {\n      const tickVal = tickWindowRef.current.values();\n      return {\n        timeDomain:\n          tickVal.length > 2 && tickVal[tickVal.length - 1] > MIN_GRAPH_TIME\n            ? [tickVal[0], tickVal[tickVal.length - 1]]\n            : [0, MIN_GRAPH_TIME],\n        position: wheelsRef.current.map(({positionWindow, color}) => ({\n          data: positionWindow.values().map((y, i) => ({x: tickVal[i], y})),\n          color\n        })),\n        velocity: wheelsRef.current.map(({velocityWindow, color}) => ({\n          data: velocityWindow.values().map((y, i) => ({x: tickVal[i], y})),\n          color\n        })),\n        power: wheelsRef.current.map(({powerWindow, color}) => ({\n          data: powerWindow.values().map((y, i) => ({x: tickVal[i], y})),\n          color\n        }))\n      };\n    } else\n      return {\n        timeDomain: [0, MIN_GRAPH_TIME],\n        position: [],\n        velocity: [],\n        power: []\n      };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [proccessedTickRef.current]);\n\n  const axisStyle = {\n    text: {fontSize: '1.2em', fill: '#d4d4d4'},\n    title: {fontSize: '1.1em', fill: '#d4d4d4'}\n  };\n\n  return (\n    <div className=\"robot-sim-container\" style={{width, height, ...style}}>\n      <canvas\n        className={className}\n        ref={canvasRef}\n        width={width}\n        height={canvasHeight}\n        style={{gridArea: 'canvas'}}\n      />\n      <div\n        style={{\n          display: 'flex',\n          flexDirection: 'column',\n          gridArea: 'editor',\n          overflowY: 'auto'\n        }}\n      >\n        <ControllerEditor\n          onCodeUpdate={factory => setFactory({factory})}\n          initialCode={codeSelection.code}\n          style={{flexGrow: 1}}\n        />\n        <div style={{display: 'flex', alignContent: 'center'}}>\n          <Form.Control\n            as=\"select\"\n            size=\"lg\"\n            style={{width: 'auto', marginRight: '0.4em'}}\n            value={codeSelection.name}\n            onChange={e =>\n              setCodeSelection({\n                name: e.target.value,\n                code: CONTROLLER_MAP.get(e.target.value) as string\n              })\n            }\n          >\n            {Array.from(CONTROLLER_MAP.keys()).map(name => (\n              <option key={name}>{name}</option>\n            ))}\n          </Form.Control>\n          <Form.Control\n            as=\"select\"\n            size=\"lg\"\n            style={{width: 'auto', marginRight: '0.4em'}}\n            value={carSelection.name}\n            onChange={e =>\n              setCarSelection({\n                name: e.target.value,\n                config: CAR_CONFIG_MAP.get(e.target.value) as any\n              })\n            }\n          >\n            {Array.from(CAR_CONFIG_MAP.keys()).map(name => (\n              <option key={name}>{name}</option>\n            ))}\n          </Form.Control>\n          <Button\n            variant=\"danger\"\n            size=\"lg\"\n            onClick={() => setSimulationNumber(simulationNumber + 1)}\n            style={{marginRight: '0.4em'}}\n          >\n            Reload\n          </Button>\n          {simulationActive ? (\n            <Button\n              variant=\"warning\"\n              size=\"lg\"\n              onClick={() => {\n                setSimulationActive(false);\n              }}\n            >\n              Pause\n            </Button>\n          ) : (\n            <Button\n              variant=\"success\"\n              size=\"lg\"\n              onClick={() => {\n                setSimulationActive(true);\n              }}\n            >\n              Play\n            </Button>\n          )}\n        </div>\n      </div>\n      <XYPlot\n        xDomain={res.timeDomain}\n        yDomain={[-1.1, 1.1]}\n        width={width / 5}\n        height={(height / 3) * 2}\n        margin={{left: 65}}\n        dontCheckIfEmpty\n      >\n        <HorizontalGridLines />\n        {res.power.map(({data, color}, i) => (\n          <LineSeriesCanvas key={i} data={data} color={color} />\n        ))}\n        <XAxis style={axisStyle} title=\"Time (ms)\" tickTotal={5} />\n        <YAxis style={axisStyle} title=\"Power\" />\n      </XYPlot>\n      <XYPlot\n        xDomain={res.timeDomain}\n        yDomain={[-400, width - 200]}\n        width={width / 5}\n        height={(height / 3) * 2}\n        margin={{left: 65}}\n        dontCheckIfEmpty\n      >\n        <HorizontalGridLines />\n        {res.position.map(({data, color}, i) => (\n          <LineSeriesCanvas key={i} data={data} color={color} />\n        ))}\n        <XAxis style={axisStyle} title=\"Time (ms)\" tickTotal={5} />\n        <YAxis style={axisStyle} title=\"Distance (px)\" />\n      </XYPlot>\n      <XYPlot\n        xDomain={res.timeDomain}\n        yDomain={[-600, 1000]}\n        width={width / 5}\n        height={(height / 3) * 2}\n        margin={{left: 65}}\n        dontCheckIfEmpty\n      >\n        <HorizontalGridLines />\n        {res.velocity.map(({data, color}, i) => (\n          <LineSeriesCanvas key={i} data={data} color={color} />\n        ))}\n        <XAxis style={axisStyle} title=\"Time (ms)\" tickTotal={5} />\n        <YAxis style={axisStyle} title=\"Velocity (px/s)\" />\n      </XYPlot>\n    </div>\n  );\n};\n\nexport default RobotSim;\n","import * as React from 'react';\nimport AutoSizer from './AutoSizer';\nimport RobotSim from './RobotSim';\n\nexport default function Page() {\n  // TODO: detect resize?\n  return (\n    <AutoSizer>\n      {({width, height}) => (\n        <RobotSim width={width} height={height} active={true} />\n      )}\n    </AutoSizer>\n  );\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport 'bootstrap/dist/css/bootstrap.min.css';\nimport Page from './components/Page';\n\nReactDOM.render(\n  <React.StrictMode>\n    <Page />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n"],"sourceRoot":""}